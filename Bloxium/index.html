<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Grow a Garden 3D</title>
  <link rel="stylesheet" href="index.css">
</head>
<body>

  <!-- GUI Circle -->
  <div id="guiStart">
  </div>
  <div id="guiMenu">
  </div>
  <div id="guiChat">
  </div>
  <div id="guiEmote">
  </div>

  <!-- Hint -->
  <div id="hint">
    Grow a Farm v0.0.1
  </div>

  <!-- Mobile Controls -->
  <div id="joystick"><div id="stick"></div></div>
  <div id="jumpBtn"></div>

  <!-- THREE.JS -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>

  <script>
  /* =========================================
     GROW A GARDEN 3D HQ ENGINE
  ========================================= */

  /* ---------- Scene Setup ---------- */
  const scene = new THREE.Scene();
  scene.background = new THREE.Color("#87CEEB");

  const camera = new THREE.PerspectiveCamera(
    75,
    window.innerWidth / window.innerHeight,
    0.1,
    2000
  );

  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  /* ---------- Lighting ---------- */
  scene.add(new THREE.AmbientLight("white", 0.4));

  const sun = new THREE.DirectionalLight("white", 1);
  sun.position.set(20, 30, 10);
  scene.add(sun);

  /* ---------- Ground Platform ---------- */
  const groundSize = 60;

  const ground = new THREE.Mesh(
    new THREE.PlaneGeometry(groundSize, groundSize),
    new THREE.MeshStandardMaterial({ color: "#3cb043" })
  );

  ground.rotation.x = -Math.PI / 2;
  scene.add(ground);

  /* ---------- Player ---------- */
  const player = new THREE.Mesh(
    new THREE.BoxGeometry(1, 1, 1),
    new THREE.MeshStandardMaterial({ color: "yellow" })
  );

  player.position.set(0, 8, 0);
  scene.add(player);

  /* ---------- Physics ---------- */
  let velocityY = 0;
  const gravity = -0.02;
  const jumpForce = 0.35;
  let onGround = false;

  const VOID_Y = -40;

  /* Raycast collision */
  const raycaster = new THREE.Raycaster();

  /* ---------- Input ---------- */
  let keys = {};
  window.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
  window.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

  /* ---------- Mobile UI ---------- */
  const joystick = document.getElementById("joystick");
  const stick = document.getElementById("stick");
  const jumpBtn = document.getElementById("jumpBtn");

  function isMobile() {
    return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  }

  if (isMobile()) {
    joystick.style.display = "block";
    jumpBtn.style.display = "block";
  }

  /* ---------- Joystick Movement ---------- */
  let joyX = 0, joyY = 0;
  let joyActive = false;

  joystick.addEventListener("touchstart", () => joyActive = true);

  joystick.addEventListener("touchmove", e => {
    if (!joyActive) return;

    const rect = joystick.getBoundingClientRect();
    const t = e.touches[0];

    let x = t.clientX - rect.left - rect.width/2;
    let y = t.clientY - rect.top - rect.height/2;

    x = Math.max(-45, Math.min(45, x));
    y = Math.max(-45, Math.min(45, y));

    stick.style.left = 37 + x + "px";
    stick.style.top = 37 + y + "px";

    joyX = x / 45;
    joyY = y / 45;
  });

  joystick.addEventListener("touchend", () => {
    joyActive = false;
    joyX = joyY = 0;
    stick.style.left = "37px";
    stick.style.top = "37px";
  });

  /* ---------- Jump Button ---------- */
  jumpBtn.addEventListener("touchstart", () => {
    if (onGround) {
      velocityY = jumpForce;
      onGround = false;
    }
  });

  /* ---------- Camera Look ---------- */
  let yaw = 0;
  let pitch = 0;

  const maxPitch = Math.PI/2 - 0.05;
  const minPitch = -Math.PI/2 + 0.05;

  /* Desktop mouse */
  window.addEventListener("mousemove", e => {
    if (isMobile()) return;

    yaw -= e.movementX * 0.0025;
    pitch -= e.movementY * 0.0025;

    pitch = Math.max(minPitch, Math.min(maxPitch, pitch));
  });

  /* Mobile drag (ignore joystick + jump areas) */
  let dragging = false;
  let lastX = 0, lastY = 0;

  function touchOnUI(touch) {
    const x = touch.clientX;
    const y = touch.clientY;

    const joyRect = joystick.getBoundingClientRect();
    const jumpRect = jumpBtn.getBoundingClientRect();

    if (
      x >= joyRect.left && x <= joyRect.right &&
      y >= joyRect.top && y <= joyRect.bottom
    ) return true;

    if (
      x >= jumpRect.left && x <= jumpRect.right &&
      y >= jumpRect.top && y <= jumpRect.bottom
    ) return true;

    return false;
  }

  window.addEventListener("touchstart", e => {
    if (!isMobile()) return;
    if (touchOnUI(e.touches[0])) return;

    dragging = true;
    lastX = e.touches[0].clientX;
    lastY = e.touches[0].clientY;
  });

  window.addEventListener("touchmove", e => {
    if (!dragging) return;
    if (touchOnUI(e.touches[0])) return;

    const t = e.touches[0];

    yaw -= (t.clientX - lastX) * 0.003;
    pitch -= (t.clientY - lastY) * 0.003;

    pitch = Math.max(minPitch, Math.min(maxPitch, pitch));

    lastX = t.clientX;
    lastY = t.clientY;
  });

  window.addEventListener("touchend", () => dragging = false);

  /* =========================================
     MAIN GAME LOOP
  ========================================= */
  function animate() {
    requestAnimationFrame(animate);

    /* Movement */
    let speed = 0.12;
    let mx = 0, mz = 0;

    if (keys["w"]) mz -= speed;
    if (keys["s"]) mz += speed;
    if (keys["a"]) mx -= speed;
    if (keys["d"]) mx += speed;

    mx += joyX * speed;
    mz += joyY * speed;

    player.position.x += mx * Math.cos(yaw) - mz * Math.sin(yaw);
    player.position.z += mz * Math.cos(yaw) + mx * Math.sin(yaw);

    /* Jump */
    if (keys[" "] && onGround) {
      velocityY = jumpForce;
      onGround = false;
    }

    /* Gravity */
    velocityY += gravity;
    player.position.y += velocityY;

    /* Raycast Ground Collision */
    raycaster.set(player.position, new THREE.Vector3(0, -1, 0));
    const hits = raycaster.intersectObject(ground);

    if (hits.length > 0 && hits[0].distance < 1.05 && velocityY <= 0) {
      player.position.y = 1;
      velocityY = 0;
      onGround = true;
    } else {
      onGround = false;
    }

    /* Void Respawn */
    if (player.position.y < VOID_Y) {
      player.position.set(0, 8, 0);
      velocityY = 0;
    }

    /* Smooth Camera Follow */
    const camDist = 9;

    camera.position.x = player.position.x + Math.sin(yaw) * camDist;
    camera.position.z = player.position.z + Math.cos(yaw) * camDist;

    camera.position.y = Math.max(
      1.5,
      player.position.y + 3 + Math.sin(pitch) * 5
    );

    camera.lookAt(
      player.position.x,
      player.position.y + 1,
      player.position.z
    );

    renderer.render(scene, camera);
  }

  animate();

  /* Resize */
  window.addEventListener("resize", () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });
  </script>

</body>
</html>
